---
/**
 * Reservation Widget - Premium UX
 * Multi-step booking flow with real-time availability
 */

const base = import.meta.env.BASE_URL;

// Generate next 30 days for date picker
const dateOptions: { value: string; label: string }[] = [];
const today = new Date();

for (let i = 0; i < 30; i++) {
  const date = new Date(today);
  date.setDate(today.getDate() + i);

  const value = date.toISOString().split("T")[0];
  const dow = date.getDay();
  const isClosed = dow === 0 || dow === 1; // Sunday or Monday

  if (!isClosed) {
    const label = date.toLocaleDateString("fr-FR", {
      weekday: "long",
      day: "numeric",
      month: "long"
    });
    dateOptions.push({
      value,
      label: label.charAt(0).toUpperCase() + label.slice(1)
    });
  }
}

// Guest options
const guestOptions = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
---

<div id="reservation-widget" class="reservation-widget">
  <!-- Step 1: Date & Guests -->
  <div id="step-1" class="step active">
    <div class="step-header">
      <span class="step-number">1</span>
      <h3 class="step-title">Choisissez votre date et nombre de couverts</h3>
    </div>

    <div class="step-content">
      <div class="form-row">
        <div class="form-group">
          <label for="reservation-date" class="label">Date</label>
          <select id="reservation-date" class="input" required>
            <option value="">Sélectionnez une date</option>
            {dateOptions.map((option) => (
              <option value={option.value}>{option.label}</option>
            ))}
          </select>
        </div>

        <div class="form-group">
          <label for="reservation-guests" class="label">Nombre de personnes</label>
          <select id="reservation-guests" class="input" required>
            <option value="">Couverts</option>
            {guestOptions.map((n) => (
              <option value={n}>{n} {n === 1 ? "personne" : "personnes"}</option>
            ))}
          </select>
          <p class="form-hint">Pour 8+ personnes, précisez vos contraintes</p>
        </div>
      </div>

      <button type="button" id="btn-check-availability" class="btn-primary w-full" disabled>
        <span class="btn-text">Voir les disponibilités</span>
        <span class="btn-loading hidden">
          <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </span>
      </button>
    </div>
  </div>

  <!-- Step 2: Time Slot -->
  <div id="step-2" class="step">
    <div class="step-header">
      <button type="button" class="step-back" id="btn-back-1" aria-label="Retour">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <span class="step-number">2</span>
      <h3 class="step-title">Choisissez votre créneau</h3>
    </div>

    <div class="step-content">
      <div id="selected-info" class="selected-info">
        <span id="selected-date-display"></span>
        <span class="separator">•</span>
        <span id="selected-guests-display"></span>
      </div>

      <div id="slots-container" class="slots-container">
        <!-- Slots will be populated dynamically -->
      </div>

      <div id="no-slots" class="no-slots hidden">
        <svg class="w-12 h-12 text-charcoal/30 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/>
        </svg>
        <p class="text-charcoal/60">Aucune disponibilité pour cette date.</p>
        <p class="text-sm text-charcoal/40 mt-1">Essayez une autre date ou contactez-nous.</p>
      </div>
    </div>
  </div>

  <!-- Step 3: Contact Information -->
  <div id="step-3" class="step">
    <div class="step-header">
      <button type="button" class="step-back" id="btn-back-2" aria-label="Retour">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <span class="step-number">3</span>
      <h3 class="step-title">Vos coordonnées</h3>
    </div>

    <div class="step-content">
      <div id="booking-summary" class="booking-summary">
        <div class="summary-row">
          <span class="summary-label">Date</span>
          <span id="summary-date" class="summary-value"></span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Heure</span>
          <span id="summary-time" class="summary-value"></span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Couverts</span>
          <span id="summary-guests" class="summary-value"></span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Service</span>
          <span id="summary-service" class="summary-value"></span>
        </div>
      </div>

      <form id="contact-form" class="contact-form">
        <input type="hidden" id="form-start-at" name="start_at" />
        <input type="hidden" id="form-service-name" name="service_name" />
        <input type="hidden" id="form-guests" name="guests" />

        <div class="form-group">
          <label for="form-name" class="label">Nom complet *</label>
          <input
            type="text"
            id="form-name"
            name="name"
            class="input"
            required
            autocomplete="name"
            placeholder="Jean Dupont"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="form-phone" class="label">Téléphone *</label>
            <input
              type="tel"
              id="form-phone"
              name="phone"
              class="input"
              required
              autocomplete="tel"
              placeholder="06 12 34 56 78"
              pattern="[0-9\s\+\-\.]+"
            />
          </div>

          <div class="form-group">
            <label for="form-email" class="label">Email (optionnel)</label>
            <input
              type="email"
              id="form-email"
              name="email"
              class="input"
              autocomplete="email"
              placeholder="jean@exemple.fr"
            />
          </div>
        </div>

        <div class="form-group">
          <label for="form-notes" class="label">Message (optionnel)</label>
          <textarea
            id="form-notes"
            name="notes"
            class="input"
            rows="3"
            placeholder="Allergies, occasion spéciale, demande particulière..."
          ></textarea>
        </div>

        <button type="submit" id="btn-submit" class="btn-primary w-full">
          <span class="btn-text">Confirmer la réservation</span>
          <span class="btn-loading hidden">
            <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        </button>

        <p class="form-legal">
          En confirmant, vous acceptez d'être recontacté pour confirmer votre réservation.
        </p>
      </form>
    </div>
  </div>

  <!-- Step 4: Confirmation -->
  <div id="step-4" class="step">
    <div class="step-content text-center">
      <div class="confirmation-icon">
        <svg class="w-16 h-16 text-success mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>

      <h3 class="confirmation-title">Réservation confirmée !</h3>

      <p class="confirmation-message">
        Merci pour votre réservation. Nous avons hâte de vous accueillir.
      </p>

      <div class="confirmation-code">
        <span class="code-label">Votre code de réservation</span>
        <span id="confirmation-code" class="code-value">ABC123</span>
      </div>

      <div id="confirmation-details" class="confirmation-details">
        <!-- Details populated dynamically -->
      </div>

      <p class="confirmation-note">
        Un email de confirmation a été envoyé si vous avez fourni votre adresse.
        Pour toute modification, contactez-nous avec votre code de réservation.
      </p>

      <div class="confirmation-actions">
        <a href={`${base}/contact`} class="btn-secondary">
          Nous contacter
        </a>
        <button type="button" id="btn-new-reservation" class="btn-ghost">
          Nouvelle réservation
        </button>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div id="error-state" class="error-state hidden">
    <div class="error-icon">
      <svg class="w-12 h-12 text-error mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg>
    </div>
    <p id="error-message" class="error-message">Une erreur est survenue.</p>
    <button type="button" id="btn-retry" class="btn-secondary">
      Réessayer
    </button>
  </div>
</div>

<style>
  .reservation-widget {
    @apply rounded-2xl border border-charcoal/10 bg-white/80 backdrop-blur-sm p-6 sm:p-8 shadow-soft;
  }

  .step {
    @apply hidden;
  }

  .step.active {
    @apply block animate-fade-in;
  }

  .step-header {
    @apply flex items-center gap-3 mb-6;
  }

  .step-number {
    @apply flex items-center justify-center w-8 h-8 rounded-full bg-olive text-cream text-sm font-semibold;
  }

  .step-title {
    @apply font-display text-lg font-semibold text-charcoal flex-1;
  }

  .step-back {
    @apply p-1.5 -ml-1 rounded-lg text-charcoal/60 hover:bg-charcoal/5 hover:text-charcoal transition-colors;
  }

  .step-content {
    @apply space-y-5;
  }

  .form-row {
    @apply grid gap-4 sm:grid-cols-2;
  }

  .form-group {
    @apply space-y-1.5;
  }

  .form-hint {
    @apply text-xs text-charcoal/50 mt-1;
  }

  .form-legal {
    @apply text-xs text-charcoal/50 text-center mt-4;
  }

  .selected-info {
    @apply flex items-center gap-2 text-sm text-charcoal/70 bg-cream/50 rounded-lg px-4 py-2.5;
  }

  .separator {
    @apply text-charcoal/30;
  }

  .slots-container {
    @apply space-y-4;
  }

  .service-group {
    @apply space-y-2;
  }

  .service-label {
    @apply text-sm font-medium text-charcoal/70;
  }

  .slots-grid {
    @apply grid grid-cols-3 sm:grid-cols-4 gap-2;
  }

  .slot-btn {
    @apply px-3 py-2.5 rounded-xl border border-charcoal/15 text-sm font-medium transition-all duration-200;
    @apply hover:border-olive hover:bg-olive/5;
    @apply focus:outline-none focus-visible:ring-2 focus-visible:ring-olive;
  }

  .slot-btn.selected {
    @apply border-olive bg-olive text-cream;
  }

  .slot-btn:disabled {
    @apply opacity-40 cursor-not-allowed hover:border-charcoal/15 hover:bg-transparent;
  }

  .no-slots {
    @apply text-center py-8;
  }

  .booking-summary {
    @apply bg-cream/50 rounded-xl p-4 space-y-2;
  }

  .summary-row {
    @apply flex justify-between text-sm;
  }

  .summary-label {
    @apply text-charcoal/60;
  }

  .summary-value {
    @apply font-medium text-charcoal;
  }

  .contact-form {
    @apply space-y-4 pt-2;
  }

  .confirmation-icon {
    @apply mb-4;
  }

  .confirmation-title {
    @apply font-display text-2xl font-semibold text-charcoal mb-2;
  }

  .confirmation-message {
    @apply text-charcoal/70 mb-6;
  }

  .confirmation-code {
    @apply bg-olive/10 rounded-xl p-4 mb-6;
  }

  .code-label {
    @apply block text-sm text-charcoal/60 mb-1;
  }

  .code-value {
    @apply block font-display text-2xl font-bold text-olive tracking-wider;
  }

  .confirmation-details {
    @apply text-left bg-cream/50 rounded-xl p-4 space-y-2 mb-6 text-sm;
  }

  .confirmation-note {
    @apply text-xs text-charcoal/50 mb-6;
  }

  .confirmation-actions {
    @apply flex flex-col sm:flex-row gap-3 justify-center;
  }

  .error-state {
    @apply text-center py-8;
  }

  .error-icon {
    @apply mb-4;
  }

  .error-message {
    @apply text-charcoal/70 mb-4;
  }

  .btn-primary {
    @apply inline-flex items-center justify-center gap-2 rounded-xl bg-olive px-6 py-3 font-semibold text-cream transition-all duration-200;
    @apply hover:bg-olive-600 active:bg-olive-700;
    @apply disabled:opacity-50 disabled:cursor-not-allowed;
  }

  .btn-secondary {
    @apply inline-flex items-center justify-center gap-2 rounded-xl border-2 border-olive px-6 py-3 font-semibold text-olive transition-all duration-200;
    @apply hover:bg-olive hover:text-cream;
  }

  .btn-ghost {
    @apply inline-flex items-center justify-center gap-2 rounded-xl px-6 py-3 font-semibold text-olive transition-all duration-200;
    @apply hover:bg-olive/10;
  }

  @keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .animate-fade-in {
    animation: fade-in 0.3s ease-out;
  }
</style>

<script>
  // Reservation Widget Logic
  const widget = document.getElementById("reservation-widget");
  if (!widget) throw new Error("Widget not found");

  // Elements
  const steps = {
    step1: document.getElementById("step-1"),
    step2: document.getElementById("step-2"),
    step3: document.getElementById("step-3"),
    step4: document.getElementById("step-4")
  };

  const elements = {
    dateSelect: document.getElementById("reservation-date") as HTMLSelectElement,
    guestsSelect: document.getElementById("reservation-guests") as HTMLSelectElement,
    btnCheckAvailability: document.getElementById("btn-check-availability") as HTMLButtonElement,
    btnBack1: document.getElementById("btn-back-1"),
    btnBack2: document.getElementById("btn-back-2"),
    selectedDateDisplay: document.getElementById("selected-date-display"),
    selectedGuestsDisplay: document.getElementById("selected-guests-display"),
    slotsContainer: document.getElementById("slots-container"),
    noSlots: document.getElementById("no-slots"),
    summaryDate: document.getElementById("summary-date"),
    summaryTime: document.getElementById("summary-time"),
    summaryGuests: document.getElementById("summary-guests"),
    summaryService: document.getElementById("summary-service"),
    contactForm: document.getElementById("contact-form") as HTMLFormElement,
    formStartAt: document.getElementById("form-start-at") as HTMLInputElement,
    formServiceName: document.getElementById("form-service-name") as HTMLInputElement,
    formGuests: document.getElementById("form-guests") as HTMLInputElement,
    btnSubmit: document.getElementById("btn-submit") as HTMLButtonElement,
    confirmationCode: document.getElementById("confirmation-code"),
    confirmationDetails: document.getElementById("confirmation-details"),
    btnNewReservation: document.getElementById("btn-new-reservation"),
    errorState: document.getElementById("error-state"),
    errorMessage: document.getElementById("error-message"),
    btnRetry: document.getElementById("btn-retry")
  };

  // State
  let state = {
    date: "",
    guests: 0,
    selectedSlot: null as { start_at: string; service_name: string; display_name: string } | null,
    availability: null as any
  };

  // Utility functions
  const showStep = (stepNum: number) => {
    Object.values(steps).forEach((step, i) => {
      if (step) {
        step.classList.toggle("active", i + 1 === stepNum);
      }
    });
    elements.errorState?.classList.add("hidden");
  };

  const setLoading = (btn: HTMLButtonElement, loading: boolean) => {
    const text = btn.querySelector(".btn-text");
    const spinner = btn.querySelector(".btn-loading");
    if (text) text.classList.toggle("hidden", loading);
    if (spinner) spinner.classList.toggle("hidden", !loading);
    btn.disabled = loading;
  };

  const showError = (message: string) => {
    if (elements.errorMessage) elements.errorMessage.textContent = message;
    elements.errorState?.classList.remove("hidden");
  };

  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    return date.toLocaleDateString("fr-FR", {
      weekday: "long",
      day: "numeric",
      month: "long"
    });
  };

  const formatTime = (isoString: string) => {
    const date = new Date(isoString);
    return date.toLocaleTimeString("fr-FR", {
      hour: "2-digit",
      minute: "2-digit"
    });
  };

  // Step 1: Enable check availability button
  const updateStep1Button = () => {
    const dateValid = elements.dateSelect?.value;
    const guestsValid = elements.guestsSelect?.value;
    if (elements.btnCheckAvailability) {
      elements.btnCheckAvailability.disabled = !(dateValid && guestsValid);
    }
  };

  elements.dateSelect?.addEventListener("change", updateStep1Button);
  elements.guestsSelect?.addEventListener("change", updateStep1Button);

  // Check availability
  elements.btnCheckAvailability?.addEventListener("click", async () => {
    state.date = elements.dateSelect.value;
    state.guests = parseInt(elements.guestsSelect.value);

    setLoading(elements.btnCheckAvailability, true);

    try {
      // For demo/fallback when Supabase is not configured
      const supabaseUrl = (import.meta as any).env?.PUBLIC_SUPABASE_URL;

      if (!supabaseUrl) {
        // Demo mode - generate mock slots
        state.availability = generateMockAvailability(state.date, state.guests);
      } else {
        // Real API call
        const response = await fetch(
          `${supabaseUrl}/functions/v1/availability?date=${state.date}&guests=${state.guests}`,
          {
            headers: {
              Authorization: `Bearer ${(import.meta as any).env?.PUBLIC_SUPABASE_ANON_KEY || ""}`,
              "Content-Type": "application/json"
            }
          }
        );

        if (!response.ok) throw new Error("API error");
        state.availability = await response.json();
      }

      renderSlots();
      showStep(2);

      if (elements.selectedDateDisplay) {
        elements.selectedDateDisplay.textContent = formatDate(state.date);
      }
      if (elements.selectedGuestsDisplay) {
        elements.selectedGuestsDisplay.textContent = `${state.guests} ${state.guests === 1 ? "personne" : "personnes"}`;
      }
    } catch (error) {
      showError("Impossible de charger les disponibilités. Veuillez réessayer.");
    } finally {
      setLoading(elements.btnCheckAvailability, false);
    }
  });

  // Generate mock availability for demo
  function generateMockAvailability(date: string, guests: number) {
    const dow = new Date(date).getDay();
    const services = [];

    // Check if has midi service (Wed, Thu, Fri)
    if ([3, 4, 5].includes(dow)) {
      const midiSlots = [];
      for (let h = 12; h <= 13; h++) {
        for (let m of [0, 30]) {
          const d = new Date(date);
          d.setHours(h, m, 0, 0);
          midiSlots.push({
            start_at: d.toISOString(),
            available_capacity: Math.max(0, 100 - Math.floor(Math.random() * 60))
          });
        }
      }
      services.push({
        name: "midi",
        display_name: "Déjeuner",
        slots: midiSlots.filter(s => s.available_capacity >= guests)
      });
    }

    // Evening service (Tue-Sat)
    if ([2, 3, 4, 5, 6].includes(dow)) {
      const soirSlots = [];
      for (let h = 19; h <= 21; h++) {
        for (let m of [0, 30]) {
          if (h === 21 && m === 30) continue; // Skip 21:30
          const d = new Date(date);
          d.setHours(h, m, 0, 0);
          soirSlots.push({
            start_at: d.toISOString(),
            available_capacity: Math.max(0, 100 - Math.floor(Math.random() * 70))
          });
        }
      }
      services.push({
        name: "soir",
        display_name: "Dîner",
        slots: soirSlots.filter(s => s.available_capacity >= guests)
      });
    }

    return { date, services };
  }

  // Render available slots
  function renderSlots() {
    if (!elements.slotsContainer || !state.availability) return;

    const { services } = state.availability;
    const hasSlots = services.some((s: any) => s.slots.length > 0);

    if (!hasSlots) {
      elements.slotsContainer.innerHTML = "";
      elements.noSlots?.classList.remove("hidden");
      return;
    }

    elements.noSlots?.classList.add("hidden");
    elements.slotsContainer.innerHTML = services
      .filter((service: any) => service.slots.length > 0)
      .map((service: any) => `
        <div class="service-group">
          <p class="service-label">${service.display_name}</p>
          <div class="slots-grid">
            ${service.slots.map((slot: any) => `
              <button
                type="button"
                class="slot-btn"
                data-start="${slot.start_at}"
                data-service="${service.name}"
                data-display="${service.display_name}"
                ${slot.available_capacity < state.guests ? "disabled" : ""}
              >
                ${formatTime(slot.start_at)}
              </button>
            `).join("")}
          </div>
        </div>
      `).join("");

    // Add click handlers
    elements.slotsContainer.querySelectorAll(".slot-btn:not([disabled])").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const target = e.currentTarget as HTMLButtonElement;

        // Clear previous selection
        elements.slotsContainer?.querySelectorAll(".slot-btn").forEach(b => b.classList.remove("selected"));
        target.classList.add("selected");

        state.selectedSlot = {
          start_at: target.dataset.start || "",
          service_name: target.dataset.service || "",
          display_name: target.dataset.display || ""
        };

        // Go to step 3
        setTimeout(() => {
          populateSummary();
          showStep(3);
        }, 200);
      });
    });
  }

  // Populate booking summary
  function populateSummary() {
    if (!state.selectedSlot) return;

    if (elements.summaryDate) elements.summaryDate.textContent = formatDate(state.date);
    if (elements.summaryTime) elements.summaryTime.textContent = formatTime(state.selectedSlot.start_at);
    if (elements.summaryGuests) elements.summaryGuests.textContent = `${state.guests} ${state.guests === 1 ? "personne" : "personnes"}`;
    if (elements.summaryService) elements.summaryService.textContent = state.selectedSlot.display_name;

    if (elements.formStartAt) elements.formStartAt.value = state.selectedSlot.start_at;
    if (elements.formServiceName) elements.formServiceName.value = state.selectedSlot.service_name;
    if (elements.formGuests) elements.formGuests.value = String(state.guests);
  }

  // Back buttons
  elements.btnBack1?.addEventListener("click", () => showStep(1));
  elements.btnBack2?.addEventListener("click", () => showStep(2));

  // Submit reservation
  elements.contactForm?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(elements.contactForm);
    const data = {
      start_at: formData.get("start_at") as string,
      service_name: formData.get("service_name") as string,
      guests: parseInt(formData.get("guests") as string),
      name: formData.get("name") as string,
      phone: formData.get("phone") as string,
      email: formData.get("email") as string || undefined,
      notes: formData.get("notes") as string || undefined
    };

    setLoading(elements.btnSubmit, true);

    try {
      const supabaseUrl = (import.meta as any).env?.PUBLIC_SUPABASE_URL;
      let result;

      if (!supabaseUrl) {
        // Demo mode - generate mock response
        result = {
          ok: true,
          code: generateCode(),
          reservation_id: "demo-" + Date.now()
        };
      } else {
        // Real API call
        const response = await fetch(`${supabaseUrl}/functions/v1/book`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${(import.meta as any).env?.PUBLIC_SUPABASE_ANON_KEY || ""}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        });
        result = await response.json();
      }

      if (result.ok) {
        showConfirmation(result.code, data);
        showStep(4);
      } else {
        showError(result.error || "Une erreur est survenue");
      }
    } catch (error) {
      showError("Erreur de connexion. Veuillez réessayer.");
    } finally {
      setLoading(elements.btnSubmit, false);
    }
  });

  // Generate mock code
  function generateCode() {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    return Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join("");
  }

  // Show confirmation
  function showConfirmation(code: string, data: any) {
    if (elements.confirmationCode) {
      elements.confirmationCode.textContent = code;
    }

    if (elements.confirmationDetails && state.selectedSlot) {
      elements.confirmationDetails.innerHTML = `
        <div class="summary-row">
          <span class="summary-label">Date</span>
          <span class="summary-value">${formatDate(state.date)}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Heure</span>
          <span class="summary-value">${formatTime(state.selectedSlot.start_at)}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Couverts</span>
          <span class="summary-value">${data.guests}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Nom</span>
          <span class="summary-value">${data.name}</span>
        </div>
      `;
    }
  }

  // New reservation button
  elements.btnNewReservation?.addEventListener("click", () => {
    state = { date: "", guests: 0, selectedSlot: null, availability: null };
    elements.contactForm?.reset();
    elements.dateSelect.value = "";
    elements.guestsSelect.value = "";
    updateStep1Button();
    showStep(1);
  });

  // Retry button
  elements.btnRetry?.addEventListener("click", () => {
    elements.errorState?.classList.add("hidden");
  });
</script>
